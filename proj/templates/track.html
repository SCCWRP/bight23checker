<html>
<head>
	<link rel="stylesheet" type="text/css" href="{{url_for('static', filename = 'button.css')}}">
	<link rel="stylesheet" type="text/css" href="{{url_for('static', filename = 'trackform.css')}}">
{% if authorized %}
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.16/css/jquery.dataTables.min.css">
  <style>
	.datatablerowhighlight {
    		background-color: #ECFFB3 !important;
	}
  </style>
  <script type="text/javascript" language="javascript" src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script type="text/javascript" language="javascript" src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
  <script type="text/javascript">
  	$(document).ready( function () {
    		 $('#track_table').DataTable( { "order": [[ 5, "desc" ]], "paging": true, "pageLength": 50 } );
	} );
  </script>
</head>
<body>
<table id="track_table" class="display">
<thead><tr><th>Email</th><th>Agency</th><th>Submission ID</th><th>Datatype</th><th>Submit</th><th>Created Date</th><th>Log File</th></tr></thead>
<tbody>
	{% for s in session_json %}
		{% set submit_file = 'https://nexus.sccwrp.org/bight23checker/download/' + s.submissionid|string + '/' + s.original_filename %}
		<tr>
		<td>{{ s.login_email }}</td><td>{{ s.login_agency }}</td><td>{{ s.submissionid }}</td><td>{{ s.datatype }}</td><td>{{ s.submit }}</td><td>{{ s.created_date }}</td><td><a href="{{ submit_file }}"> {{ s.original_filename }} </a></td>
		</tr>
	{% endfor %}
{% else %}

	<form id="track-auth-form">
		<label for="trackpw">Please sign in to view the submission tracking (The password is exactly what you think it is)</label>
		<input type="password" name="trackpw">
		<button id="track-auth-submit-btn" class="btn btn-primary" type="submit">Submit</button>
	</form>
{% endif %}
</tbody>
</table>
</body>
<script type="text/javascript">
	document.getElementById('track-auth-form')?.addEventListener('submit', (event) => {
		event.preventDefault();
		const formData = new FormData(event.target);
		fetch(
			`{{request.script_root}}/trackauth`, 
			{
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify(Object.fromEntries(formData.entries()))
			}
		)
		.then(response => {
			if (!response.ok) {
				throw new Error('Network response was not ok');
			}
			return response.json();
		})
		.then(data => {
			console.log(data);
			if (data.message === 'true') {
				window.location = `{{request.script_root}}/track`
			}
		})
		.catch(error => {
			console.error('There was a problem submitting the form', error);
		});
	})
</script>
</html>
