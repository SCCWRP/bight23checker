<!DOCTYPE html>

<html>
<head>
    <title>Table Information</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <style>
        .table td, .table th {
            border: 1px solid #ddd; /* Light grey border */
        }
    </style>
    
    </style>
</head>
<body>
    <div>
        {% if datatypes_list %}
        <p>Choose a datatype:</p>
        {% for dtyp in datatypes_list %}
        <ul>
            <li>
                <a href="{{request.script_root}}/schema?datatype={{dtyp}}">{{dtyp}}</a>
            </li>
        </ul>
        {% endfor %}
    {% else %}
    </div>
    <div class="container d-flex flex-column align-items-center justify-content-center">
    <h1>Schema Information for {{datatype}}</h1>
    <br>
    <a href="{{request.script_root}}/schema"><button id="return-main-app"> Return to main page </button></a>
    <br>
    <a href="{{request.script_root}}/schema?datatype={{datatype}}&download=true" target=_blank><button id="download-schema"> Download as an Excel file </button></a>
    <br>
    <a href="{{request.script_root}}/adminauth?redirect_to=schema"><button id="edit-schema"> Log in to edit </button></a>
    <br>
    {# metadata is essentially the schema information about all tables in the datatype #}
    
    {% for tablename, table in metadata.items() %}
        <div class="table-info-container">
            <div class="table-name-container">
                <h3><strong>{{tablename}}</strong></h3>
            </div>
            <div class="table-content-container">
                <table class="table table-striped table-hover">                    
                    {% for row in table %}
                        {# for the first loop, add the table header #}
                        {% if loop.index0 == 0 %}
                        <thead>
                            {% for k, v in row.items() %}
                            <th>{{ k | replace("_", " ") }}</th>
                            {% endfor %}
                        </thead>
                        {% endif %}
                        {% for k, v in row.items() %}
                            {% if loop.index0 == 0 %}
                                <tr data-parent-table="{{tablename}}" data-column-name="{{v}}" {% if row.primary_key == 'YES' %} class="primary-key-row" {% endif %}>
                            {% endif %}
                                {% if ((authorized) and (k == 'description')) %}
                                    <td class="editable-description-cell" contenteditable="true">{{v | safe}}</td>
                                {% else %}
                                    <td>{{v | safe}}</td>
                                {%endif%}
                        {% endfor %}    
                        </tr>
                    {% endfor %}
                </table>
            </div>
        </div>
        <br><br>
    {% endfor %}
    </div>

    {% endif %}
</body>

{% if authorized %}
<script>
    Array.from(document.getElementsByClassName('editable-description-cell')).forEach(cell => {
        cell.addEventListener('blur', function() {
            const colDescription = this.innerText;
            const parentTable = this.parentNode.dataset.parentTable;
            const colName = this.parentNode.dataset.columnName;
            saveChanges(parentTable, colName, colDescription);
        });

        cell.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();  // Prevents adding a new line (if the cell is a multiline input like textarea)
                this.blur();  // Remove focus from the cell
            }
        });
    });
    const saveChanges = function(tableName, colName, txt) {
        fetch("{{request.script_root}}/save-changes", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                "tablename": tableName,
                "column_name" : colName,
                "column_description" : txt 
            })
        })
        .then(response => response.json())
        .then(data => console.log(data))
    }
</script>
{% endif %}

</html>

